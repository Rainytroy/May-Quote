# May应用剪贴板功能实施文档

## 1. 功能概述

剪贴板功能是May应用的重要组成部分，旨在允许用户保存、组织和导出重要的对话内容。此次迭代将实现以下核心功能：

1. **消息气泡操作按钮**：AI回答气泡底部添加复制、引用（预留）和添加到剪贴板按钮
2. **剪贴板区域重构**：实现多Tab支持的剪贴板界面
3. **卡片管理功能**：支持拖拽排序、多选操作、导出等功能
4. **引用功能预留**：为未来引用功能提供架构基础（不实现具体功能）

## 2. 技术规格

### 2.1 数据模型

需要扩展现有的`ClipboardItem`类型，添加更多必要信息：

```typescript
export interface ClipboardItem {
  id: string;              // 唯一标识
  content: string;         // 内容文本，支持Markdown
  timestamp: number;       // 创建时间戳
  order: number;           // 排序顺序（用于拖拽排序）
  source: {                // 来源信息
    conversationId: string;  // 对话ID
    messageId: string;       // 消息ID，用于定位源消息
  };
}

// 剪贴板Tab定义
export interface ClipboardTab {
  id: string;              // Tab唯一标识
  title: string;           // Tab标题
  type: 'clipboard' | 'custom'; // Tab类型
  closable: boolean;       // 是否可关闭
}
```

### 2.2 组件结构

#### 组件层次和职责

```
Export/
├── MessageActions/                 // 消息气泡操作按钮组件
│   ├── 职责：提供消息操作按钮（复制、引用、添加到剪贴板）
│   └── 属性：message, onCopy, onQuote, onAddToClipboard
│
├── ClipboardArea/                  // 剪贴板主容器
│   ├── 职责：管理剪贴板整体状态和布局
│   └── 属性：items, onUpdateItems, onExport
│
├── ClipboardHeader/                // 剪贴板头部组件
│   ├── ClipboardTabs/              // 剪贴板Tab组件
│   │   ├── 职责：显示和管理多个Tab
│   │   └── 属性：tabs, activeTabId, onTabChange, onTabClose, onTabAdd
│   │
│   └── ClipboardToolbar/           // 剪贴板工具栏
│       ├── 职责：提供导出、多选等操作按钮
│       └── 属性：onSelectMode, onExportMarkdown, onExportPDF
│
├── ClipboardList/                  // 剪贴板内容列表
│   ├── 职责：显示卡片列表，处理拖拽排序
│   ├── 属性：items, selectMode, selectedIds, onReorder
│   │
│   └── ClipboardCard/              // 剪贴板卡片组件
│       ├── 职责：显示单个剪贴板项内容和操作按钮
│       └── 属性：item, selectMode, selected, onSelect, onCopy, onQuote, onLocate, onDelete
│
└── ClipboardSelectionToolbar/      // 多选模式工具栏
    ├── 职责：提供多选模式下的批量操作
    └── 属性：selectedCount, onQuoteSelected, onExportSelected, onCancel
```

### 2.3 数据流设计

#### 状态管理

剪贴板数据将整合到现有的`useConversations` hook中，主要变更：

1. 扩展`Conversation`接口，添加`clipboardItems`数组字段
2. 在`useConversations` hook中添加剪贴板管理方法：
   - `addToClipboard(messageId)` - 添加消息到剪贴板
   - `removeClipboardItem(itemId)` - 从剪贴板移除项目
   - `reorderClipboardItems(items)` - 更新排序后的剪贴板项
   - `clearClipboard()` - 清空剪贴板

#### 数据持久化

剪贴板数据将与对话数据一起存储在IndexedDB中，确保数据持久性：

1. 在`storage-db.ts`中更新对话存储和读取逻辑，包含剪贴板项
2. 实现高效的持久化策略，避免不必要的全量保存

### 2.4 UI设计与交互

#### 消息操作按钮

- 设计为灰色半透明小图标，hover时变为全色并显示文本提示
- 位于AI消息气泡底部，整齐排列
- 点击"复制"后显示轻量级成功提示
- 点击"添加到剪贴板"后，内容自动添加并滚动到剪贴板底部

#### 剪贴板Tab设计

- 采用VS Code风格的方角扁平设计
- 默认Tab为"剪贴板"，不可关闭
- Tab右侧显示更多操作按钮，点击弹出下拉菜单
- 预留多Tab的架构支持

#### 卡片拖拽排序

- 实现流畅的拖放体验，拖动时显示卡片阴影
- 使用`react-beautiful-dnd`库实现拖拽功能
- 卡片间留有适当空隙，便于视觉识别
- 拖放结束后自动保存新的排序

#### 多选功能

- 启用多选模式后，卡片左侧显示勾选框
- 底部出现悬浮工具栏，提供批量操作选项
- 支持全选/取消全选功能
- 退出多选模式时恢复正常视图

#### 导出功能

- 支持导出单个卡片、选中卡片或全部卡片
- Markdown导出：保留格式的纯文本文件
- PDF导出：格式化的PDF文档，保留排版和样式

## 3. 详细实施计划

### 3.1 前置准备

1. **类型定义更新**
   - 更新`ClipboardItem`接口，添加排序和源消息追踪功能
   - 扩展`Conversation`接口，确保包含剪贴板项数组
   - 添加`ClipboardTab`类型定义

2. **依赖添加**
   - 安装`react-beautiful-dnd`库用于拖拽功能
   - 安装`jspdf`和`html2canvas`用于PDF导出功能

### 3.2 具体实施步骤

#### 阶段一：基础组件实现

1. **MessageActions组件实现**
   - 创建消息气泡操作按钮组件
   - 实现复制功能和成功提示
   - 添加引用按钮占位
   - 实现添加到剪贴板功能

2. **ClipboardArea基础重构**
   - 创建新的文件结构
   - 实现Tab组件基础框架
   - 实现剪贴板头部和工具栏

#### 阶段二：剪贴板核心功能

3. **ClipboardCard组件**
   - 实现卡片基础布局
   - 添加操作按钮（复制、引用、定位、删除）
   - 实现Markdown渲染支持

4. **拖拽排序**
   - 集成`react-beautiful-dnd`库
   - 实现卡片拖拽功能
   - 添加拖拽状态视觉反馈
   - 实现排序后的数据持久化

#### 阶段三：高级功能实现

5. **多选功能**
   - 实现多选模式切换
   - 添加卡片选择UI
   - 创建底部操作工具栏
   - 实现批量选择和取消选择

6. **导出功能**
   - 实现Markdown导出逻辑
   - 实现PDF导出功能
   - 添加单个/批量/全部导出支持

7. **定位到源消息**
   - 实现从剪贴板项定位到源消息的功能
   - 添加源消息高亮动画效果

### 3.3 引用功能预留

虽然引用功能暂不实现，但需要预留合适架构：

1. **UI组件预留**
   - 在`MessageActions`和`ClipboardCard`中添加引用按钮
   - 在多选工具栏中添加引用功能占位

2. **数据结构预留**
   - 在数据模型中预留引用相关字段
   - 在`useChat` hook中预留引用处理方法

3. **技术文档**
   - 记录引用功能预期行为
   - 标记需要在后续迭代中完成的部分

## 4. 测试与质量保证

### 4.1 测试范围

1. **单元测试**
   - 各组件的渲染和基本功能测试
   - 剪贴板操作方法的测试

2. **交互测试**
   - 拖拽排序功能测试
   - 多选和批量操作测试
   - 导出功能测试

3. **边界条件测试**
   - 空剪贴板状态处理
   - 大量剪贴板项的性能测试
   - 长文本内容的显示和操作测试

### 4.2 性能考量

- 使用React.memo优化组件重渲染
- 拖拽操作使用节流处理，避免频繁更新
- 导出大型文档时显示进度指示器
- 预留虚拟滚动接入点，为未来优化大量卡片场景做准备

## 5. 未来扩展规划

本次实施重点关注剪贴板的基础功能和架构，但设计时考虑了以下未来扩展：

1. **多Tab功能**
   - 允许创建多个剪贴板分类
   - 支持Tab重命名和拖动排序

2. **引用功能完整实现**
   - 实现引用Tag系统
   - 添加引用内容预览
   - 实现引用内容的编辑和删除

3. **高级导出选项**
   - 支持更多导出格式（如Word、HTML）
   - 自定义导出模板
   - 批量导出选项

4. **性能优化**
   - 虚拟滚动实现
   - 懒加载和分页加载
   - 索引优化，支持内容搜索

## 6. 关键技术决策

1. **为什么选择react-beautiful-dnd**
   - 高性能、流畅的拖拽体验
   - 丰富的API和事件回调
   - 活跃的维护和良好的文档

2. **为什么将剪贴板数据存储在对话中**
   - 确保数据一致性和关联性
   - 简化数据同步和持久化逻辑
   - 便于未来功能扩展

3. **组件解耦策略**
   - 严格的props接口设计
   - 组件内部状态与应用状态分离
   - 使用回调而非直接引用外部函数
   - 抽象可重用逻辑到自定义hooks
