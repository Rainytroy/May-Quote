# 引用功能最佳实践

## 功能概述

引用功能允许用户在AI对话中引用之前的内容，增强上下文连贯性和交互深度。用户可以引用消息全文或选定片段，这些引用会显示在输入框上方，方便用户参考并融入当前对话。

## 核心组件

### 数据流与状态管理

引用功能采用Context API进行状态管理，主要通过以下组件实现：

1. **ReferenceContext**
   - 管理全局引用状态
   - 提供添加、删除和清空引用的方法
   - 在消息发送时自动合并引用内容

2. **reference-utils.ts**
   - 处理引用相关的工具函数
   - 生成预览文本(`generatePreviewText`)
   - 截断显示内容(`truncateForDisplay`)
   - 创建引用项(`createReferenceItem`)
   - 构建包含引用的完整提示(`buildFullPrompt`)

### 用户界面组件

1. **ReferenceButton**
   - 显示在消息、剪贴板卡片等位置
   - 点击时添加内容到引用
   - 统一使用双引号图标

2. **ReferenceTag**
   - 在输入框上方显示已添加的引用
   - 显示引用的预览文本（中文10字符，英文字符算0.5个）
   - 提供删除按钮
   - 鼠标悬停时显示更详细内容

3. **ReferenceTooltip**
   - 悬停时显示更完整的引用内容（最多500字符）
   - 增强用户对引用内容的理解

4. **MessageContextMenu**
   - 右键菜单中的引用选项
   - 允许引用选定的文本片段

## 用户交互最佳实践

### 引用来源

引用功能支持多种来源的内容：

1. **消息引用**
   - 通过消息操作栏的引用按钮引用整条消息
   - 通过右键菜单引用选定的文本片段

2. **剪贴板引用**
   - 从剪贴板卡片引用保存的内容
   - 支持多选模式下批量引用

### 视觉反馈

为提供良好的用户体验，引用功能实现了多层次的视觉反馈：

1. **即时反馈**
   - 引用添加成功后显示成功提示
   - 标签删除按钮有悬停效果

2. **内容预览**
   - 标签显示截断的预览文本
   - 悬停时显示更完整的内容

## 开发者最佳实践

### 组件设计

1. **分离关注点**
   - 状态管理与UI渲染分离
   - 工具函数独立于组件实现

2. **一致的视觉语言**
   - 所有引用相关组件使用统一的双引号图标
   - 保持与应用其他部分的视觉一致性

### 文本处理

1. **智能截断**
   - 预览文本根据字符类型智能截断
   - 中文字符计为1，非中文字符计为0.5
   - 保持预览文本的可读性和信息量

2. **Markdown清理**
   - 预览文本移除Markdown格式
   - 保持内容的可读性

### 拓展点

1. **引用分类**
   - 未来可考虑对引用进行分类（如代码、定义、例子等）
   - 添加标签或颜色区分不同类型的引用

2. **引用编辑**
   - 添加对引用内容的轻量级编辑功能
   - 允许用户在发送前调整引用内容

3. **引用历史**
   - 记录常用引用，便于快速重用
   - 实现引用模板功能

## 调试与测试

1. **日志记录**
   - 引用相关操作应记录适当的日志
   - 便于追踪用户行为和调试问题

2. **测试场景**
   - 测试各种长度和格式的引用内容
   - 验证中英文混合内容的显示效果
   - 检查在不同设备和窗口大小下的表现

## 性能考虑

1. **渲染优化**
   - 使用memo和useMemo减少不必要的重渲染
   - 大量引用时考虑虚拟列表

2. **数据处理**
   - 避免在UI线程进行复杂的文本处理
   - 考虑引用内容的存储限制
