# 引用功能实施方案

## 1. 概述与目标

引用功能允许用户在输入框中快速引用之前的内容，包括对话气泡、剪贴板卡片或多选内容，从而构建更加丰富的对话上下文，提升用户体验和交互效率。

### 1.1 主要用途

- 引用上下文中的重要信息进行回应
- 引用多个相关内容进行综合分析
- 便捷地引用之前的内容，减少重复输入
- 增强对话的连续性和上下文感

## 2. 功能需求与用户体验

### 2.1 引用来源

用户可以从以下三种来源引用内容：

1. **对话气泡**：引用单个气泡内的所有内容
2. **剪贴板卡片**：引用单个剪贴板卡片内的内容
3. **多选功能**：合并多个选中的剪贴板卡片内容并引用

### 2.2 用户界面

当用户引用内容时，系统将在输入框光标位置插入一个引用Tag：

- **Tag样式**：黑灰色背景，品牌绿色文本
- **Tag内容**：引用图标 + 引用文本的前10个字符 + "..."
- **布局行为**：
  - 光标自动定位在Tag之后
  - 用户可以继续输入或添加多个引用
  - 回退键可以删除整个Tag

### 2.3 交互行为

- **预览功能**：鼠标悬停在Tag上时，显示悬浮气泡，展示更多引用内容（最多500字）
- **删除操作**：在Tag后方按回退键时，删除整个Tag
- **提交行为**：用户提交时，所有引用内容按顺序与用户输入一起组成完整prompt

### 2.4 其他设计考量

- 引用内容原样保留，不进行截断或压缩
- 不在引用内容中标记来源信息
- 多个引用按添加顺序排列

## 3. 技术实现方案

### 3.1 数据模型

为支持引用功能，我们需要定义以下数据结构：

```typescript
// 引用内容数据结构
interface ReferenceItem {
  id: string;           // 唯一标识符
  content: string;      // 完整引用内容
  previewText: string;  // 预览文本（前10个字符）
  timestamp: number;    // 引用创建时间戳
}

// 消息数据结构扩展
interface Message {
  // 现有字段...
  references?: ReferenceItem[];  // 引用内容数组
}
```

### 3.2 核心组件设计

#### 3.2.1 ReferenceTag 组件

专门用于在输入框中展示引用内容的Tag组件：

```typescript
interface ReferenceTagProps {
  reference: ReferenceItem;
  onDelete: (id: string) => void;
}

const ReferenceTag: React.FC<ReferenceTagProps> = ({ reference, onDelete }) => {
  // 实现引用Tag的渲染、悬停预览和删除逻辑
}
```

#### 3.2.2 ReferenceTooltip 组件

当鼠标悬停在引用Tag上时显示的预览气泡：

```typescript
interface ReferenceTooltipProps {
  content: string;  // 完整引用内容
}

const ReferenceTooltip: React.FC<ReferenceTooltipProps> = ({ content }) => {
  // 实现预览气泡的渲染和文本截断逻辑
}
```

#### 3.2.3 ReferenceButton 组件

在消息气泡、剪贴板卡片等地方显示的引用按钮：

```typescript
interface ReferenceButtonProps {
  content: string;  // 要引用的内容
  onReference: (content: string) => void;
}

const ReferenceButton: React.FC<ReferenceButtonProps> = ({ content, onReference }) => {
  // 实现引用按钮的渲染和点击逻辑
}
```

### 3.3 工具函数

```typescript
// 生成预览文本（取前10个字符 + ...）
function generatePreviewText(content: string): string {
  if (content.length <= 10) return content;
  return content.substring(0, 10) + '...';
}

// 创建引用项
function createReferenceItem(content: string): ReferenceItem {
  return {
    id: generateId(),  // 使用现有的ID生成函数
    content,
    previewText: generatePreviewText(content),
    timestamp: Date.now()
  };
}
```

## 4. 集成到现有系统

### 4.1 修改InputArea组件

InputArea组件需要进行以下修改：

1. 添加对引用项的状态管理
2. 实现引用Tag的渲染和管理
3. 处理光标定位和Tag删除逻辑
4. 在消息提交时合并引用内容

```typescript
// InputArea组件扩展
const InputArea: React.FC = () => {
  // 现有状态...
  const [references, setReferences] = useState<ReferenceItem[]>([]);
  
  // 添加引用
  const addReference = (content: string) => {
    const newRef = createReferenceItem(content);
    setReferences([...references, newRef]);
    // 处理光标定位逻辑
  };
  
  // 删除引用
  const deleteReference = (id: string) => {
    setReferences(references.filter(ref => ref.id !== id));
  };
  
  // 提交消息时处理引用
  const handleSubmit = () => {
    // 构建完整prompt，包含引用内容
    const fullPrompt = references.map(ref => ref.content).join('\n\n') + '\n\n' + userInput;
    // 提交消息...
  };
  
  // 其他实现...
}
```

### 4.2 为消息气泡添加引用功能

在MessageItem组件中添加引用按钮和逻辑：

```typescript
const MessageItem: React.FC<MessageItemProps> = ({ message, ...props }) => {
  // 现有实现...
  
  // 添加引用处理函数
  const handleReference = () => {
    // 调用全局引用方法，传入消息内容
    onReference(message.content);
  };
  
  return (
    // 现有渲染...
    <div className="message-actions">
      {/* 现有操作按钮... */}
      <ReferenceButton content={message.content} onReference={handleReference} />
    </div>
  );
}
```

### 4.3 为剪贴板卡片添加引用功能

在ClipboardCard组件中添加引用按钮和逻辑：

```typescript
const ClipboardCard: React.FC<ClipboardCardProps> = ({ item, ...props }) => {
  // 现有实现...
  
  // 添加引用处理函数
  const handleReference = () => {
    // 调用全局引用方法，传入剪贴板内容
    onReference(item.content);
  };
  
  return (
    // 现有渲染...
    <div className="clipboard-actions">
      {/* 现有操作按钮... */}
      <ReferenceButton content={item.content} onReference={handleReference} />
    </div>
  );
}
```

### 4.4 为多选功能添加引用支持

在SelectionToolbar组件中添加引用按钮和逻辑：

```typescript
const SelectionToolbar: React.FC<SelectionToolbarProps> = ({ selectedItems, ...props }) => {
  // 现有实现...
  
  // 添加引用处理函数
  const handleReference = () => {
    // 合并所有选中内容并调用全局引用方法
    const combinedContent = selectedItems.map(item => item.content).join('\n\n');
    onReference(combinedContent);
  };
  
  return (
    // 现有渲染...
    <div className="selection-actions">
      {/* 现有操作按钮... */}
      <button onClick={handleReference}>引用选中内容</button>
    </div>
  );
}
```

## 5. 全局状态管理

为了在不同组件间共享引用功能，我们需要在全局状态中添加引用相关的方法和状态：

```typescript
// 在全局状态或Context中添加
interface GlobalState {
  // 现有状态...
  
  // 引用相关
  references: ReferenceItem[];
  addReference: (content: string) => void;
  deleteReference: (id: string) => void;
}

// 创建引用相关的Context和Provider
const ReferenceContext = React.createContext<{
  addReference: (content: string) => void;
}>({ addReference: () => {} });

const ReferenceProvider: React.FC = ({ children }) => {
  const { userInput, setUserInput } = useContext(ChatContext); // 获取输入框状态
  
  const addReference = useCallback((content: string) => {
    // 创建引用项并通知InputArea组件
    // ...
  }, []);
  
  return (
    <ReferenceContext.Provider value={{ addReference }}>
      {children}
    </ReferenceContext.Provider>
  );
};
```

## 6. CSS样式设计

引用Tag和预览气泡需要添加相应的CSS样式：

```css
/* 引用Tag样式 */
.reference-tag {
  display: inline-flex;
  align-items: center;
  background-color: var(--tag-bg, #333);
  color: var(--brand-color);
  padding: 2px 8px;
  border-radius: var(--radius-sm);
  margin: 0 4px;
  max-width: 200px;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
  position: relative;
}

/* 引用Tag图标 */
.reference-tag-icon {
  margin-right: 4px;
}

/* 预览气泡样式 */
.reference-tooltip {
  position: absolute;
  bottom: 100%;
  left: 0;
  background-color: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  padding: var(--space-md);
  width: 300px;
  max-height: 200px;
  overflow-y: auto;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  z-index: 1000;
  margin-bottom: 8px;
}
```

## 7. 实施计划

### 7.1 开发阶段

1. **准备阶段** (1天)
   - 创建数据模型和基础组件结构
   - 设计CSS样式

2. **组件开发** (2-3天)
   - 实现ReferenceTag组件
   - 实现ReferenceTooltip组件
   - 实现ReferenceButton组件

3. **输入区域集成** (2天)
   - 修改InputArea组件，支持引用功能
   - 实现光标位置管理和Tag删除逻辑

4. **功能整合** (2天)
   - 为消息气泡添加引用功能
   - 为剪贴板卡片添加引用功能
   - 为多选功能添加引用支持

5. **全局状态管理** (1天)
   - 实现ReferenceContext和Provider
   - 连接各组件与全局引用状态

6. **测试与修复** (1-2天)
   - 功能测试和边界情况处理
   - 修复问题和改进用户体验

### 7.2 关键注意事项

1. **光标管理**：确保引用Tag插入后，光标正确定位在Tag之后
2. **键盘事件**：正确处理回退键删除Tag的逻辑
3. **样式一致性**：确保引用Tag样式与应用整体设计风格一致
4. **性能考量**：处理多个引用及长文本引用时的性能影响
5. **无障碍性**：确保引用功能可通过键盘完全操作

## 8. 技术风险与解决方案

### 8.1 潜在风险

1. **光标位置管理难度**：在React中精确控制文本输入光标位置较为复杂
2. **键盘事件冲突**：需确保回退键删除Tag的逻辑不与其他快捷键冲突
3. **引用内容过长**：非常长的引用内容可能导致UI渲染问题
4. **多Tag管理复杂性**：处理多个引用Tag的增删和排序可能变得复杂

### 8.2 解决方案

1. **使用React Ref**：使用useRef和selection API精确控制光标位置
2. **自定义输入组件**：考虑使用react-contenteditable或draft.js更好地控制输入和Tag
3. **虚拟滚动**：对于长文本预览，使用虚拟滚动方案提高性能
4. **状态管理优化**：使用不可变数据结构和memo优化Tag管理性能

## 9. 总结

引用功能将显著增强May应用的用户体验，使用户能够更方便地引用之前的内容，构建更丰富的对话上下文。通过精心设计的UI交互和状态管理，我们可以确保该功能既易于使用又具有强大的功能性。

完整实施预计需要8-10个工作日，主要挑战在于输入区域的Tag管理和光标控制。通过合理的组件设计和状态管理，可以确保功能的稳定性和可维护性。
