# 对话管理功能设计

本文档详细描述May应用的对话管理功能实现方案，包括对话列表、历史对话保存和切换功能。

## 1. 需求概述

- 对话列表显示在左侧边栏（10%区域）
- 顶部有"新对话"按钮，用于创建新对话
- 历史对话作为卡片显示在列表中
- 每个对话保存消息记录（最多100条）和剪贴板内容
- 点击对话卡片可以切换到对应对话
- 对话可以被删除
- 对话内容持久化保存（页面刷新后不会丢失）

## 2. 数据结构设计

### 2.1 对话（Conversation）

```typescript
interface Conversation {
  id: string;             // 对话唯一ID
  title: string;          // 对话标题（从第一条消息生成或自定义）
  messages: Message[];    // 对话中的消息（最多保存100条）
  clipboardItems: ClipboardItem[]; // 与对话关联的剪贴板项
  createdAt: number;      // 创建时间戳
  updatedAt: number;      // 最后更新时间戳
}
```

### 2.2 对话元数据（ConversationMeta）

用于对话列表显示，减少内存占用：

```typescript
interface ConversationMeta {
  id: string;         // 对话唯一ID
  title: string;      // 对话标题
  preview: string;    // 最后一条消息的预览（截取）
  messageCount: number; // 消息数量
  updatedAt: number;  // 最后更新时间
}
```

## 3. 存储方案

### 3.1 IndexedDB 存储

使用IndexedDB进行对话数据的持久化存储：

- **对话数据库**: `may-conversations`
  - **对话存储**: `conversations` - 存储完整对话对象
  - **元数据存储**: `conversation-meta` - 存储对话元数据，用于列表显示

### 3.2 数据操作接口

```typescript
// 保存对话
saveConversation(conversation: Conversation): Promise<void>

// 获取对话元数据列表
getConversationMetaList(): Promise<ConversationMeta[]>

// 获取完整对话
getConversation(id: string): Promise<Conversation | null>

// 删除对话
deleteConversation(id: string): Promise<void>

// 更新对话标题
updateConversationTitle(id: string, title: string): Promise<void>
```

## 4. 组件设计

### 4.1 新增组件

#### ConversationList（对话列表组件）

- 位置: `/src/components/Conversation/ConversationList.tsx`
- 职责: 
  - 显示新对话按钮
  - 渲染对话卡片列表
  - 处理对话选择和删除事件

```jsx
<ConversationList
  conversations={conversationMetaList}
  activeConversationId={activeConversationId}
  onSelect={handleSelectConversation}
  onDelete={handleDeleteConversation}
  onCreateNew={handleCreateNewConversation}
/>
```

#### ConversationCard（对话卡片组件）

- 位置: `/src/components/Conversation/ConversationCard.tsx`
- 职责:
  - 显示对话标题和预览
  - 显示更新时间
  - 提供删除按钮
  - 处理点击事件

```jsx
<ConversationCard
  title={conversation.title}
  preview={conversation.preview}
  updatedAt={conversation.updatedAt}
  isActive={isActive}
  onSelect={() => onSelect(conversation.id)}
  onDelete={(e) => {
    e.stopPropagation();
    onDelete(conversation.id);
  }}
/>
```

### 4.2 组件层次结构

```
App
├── Navbar
├── ConversationList
│   ├── NewConversationButton
│   ├── ConversationCard
│   ├── ConversationCard
│   └── ...
├── ChatInterface
│   ├── MessageList
│   │   ├── MessageItem
│   │   └── ...
│   └── InputArea
└── ClipboardArea
```

## 5. 状态管理

### 5.1 useConversations Hook

- 位置: `/src/hooks/useConversations.ts`
- 职责:
  - 管理对话列表状态
  - 提供创建、加载、保存、删除对话方法
  - 处理与存储层的交互

```typescript
const {
  conversations,          // 对话元数据列表
  activeConversationId,   // 当前活动对话ID
  activeConversation,     // 当前活动对话完整数据
  createNewConversation,  // 创建新对话
  selectConversation,     // 选择对话
  deleteConversation,     // 删除对话
  updateConversation,     // 更新对话内容
  saveTitle               // 保存对话标题
} = useConversations();
```

### 5.2 修改 useChat Hook

扩展现有的useChat hook，使其能够与特定对话关联：

```typescript
// 修改后的useChat hook接口
const {
  messages,
  isLoading,
  error,
  sendMessage,
  clearMessages
} = useChat(activeConversationId, updateConversation);
```

## 6. 实现流程

### 6.1 初始化流程

1. 应用启动时，从IndexedDB加载对话元数据列表
2. 如果有存储的activeConversationId，加载对应对话
3. 如果没有对话或activeConversationId，创建新对话

### 6.2 创建新对话

1. 点击"新对话"按钮
2. 生成唯一ID
3. 创建新Conversation对象
4. 保存到IndexedDB
5. 更新activeConversationId
6. 清空当前消息区域

### 6.3 切换对话

1. 点击对话卡片
2. 保存当前对话内容
3. 设置新的activeConversationId
4. 从IndexedDB加载选中对话
5. 更新消息列表和剪贴板内容

### 6.4 删除对话

1. 点击对话卡片上的删除按钮
2. 显示确认对话框
3. 确认后从IndexedDB删除对话
4. 如果删除的是当前活动对话，切换到另一个对话或创建新对话

## 7. 优化与考虑事项

### 7.1 性能优化

- 使用虚拟列表（React Virtualized/Window）处理大量对话
- 分页加载对话元数据
- 对话消息限制为最新的100条
- 使用memo、useMemo、useCallback优化渲染

### 7.2 用户体验

- 为对话自动生成标题（基于第一条用户消息）
- 提供编辑标题功能
- 显示对话创建时间和最后更新时间
- 提供搜索和筛选功能
- 保存滚动位置，切换回对话时恢复

### 7.3 错误处理

- 存储失败时的优雅降级
- 对话加载失败的错误提示
- 数据迁移策略（版本升级时）

## 8. 下一步计划

- 实现对话分类或标签功能
- 提供对话导出/导入功能
- 添加对话置顶功能
- 实现对话内容搜索功能
- 提供对话分享功能（生成链接）
