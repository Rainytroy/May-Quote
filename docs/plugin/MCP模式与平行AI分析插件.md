# MCP模式与平行AI分析插件设计文档

## 1. 概述与背景

### 1.1 MCP模式简介

MCP (Model Context Protocol) 模式是一种AI交互设计模式，其核心理念是通过精心设计的提示词(Prompt)引导AI模型输出结构化、标准化的信息，从而实现AI与现有软件系统的高效集成。这种模式解决了传统AI交互中的几个关键问题：

- **输出不确定性**：自然语言输出格式多变，难以程序化处理
- **集成困难**：自由文本难以与现有系统API对接
- **交互成本高**：需要额外解析逻辑处理AI输出

通过MCP模式，我们可以让AI成为现有系统的"适配器"，将用户的自然语言输入转化为系统可理解的结构化数据，实现AI与传统软件系统的无缝集成。

### 1.2 平行AI插件的用途与价值

平行AI分析插件是MCP模式的一个实际应用案例，它在May聊天应用中引入了"平行思考"机制：

- **双轨分析**：用户输入同时发送给主AI和辅助AI进行处理
- **意图识别**：辅助AI专注于分析用户意图，输出结构化数据
- **场景增强**：识别特定场景后提供定制化功能建议
- **用户体验提升**：在不打断主对话流程的情况下提供增强功能

该插件的价值在于：
1. 提升了AI系统的情境感知能力
2. 为用户提供了更多元的功能入口
3. 展示了一种AI系统与传统功能集成的新范式
4. 避免了主模型需要同时处理对话内容和意图识别的认知负担

## 2. 系统架构

### 2.1 核心组件

平行AI分析插件由以下核心组件构成：

- **PluginDemo**：插件配置与测试界面，提供完整的配置、测试和可视化环境
- **PromptEditor**：提示词编辑组件，专注于系统提示词设计与编辑
- **ApiConfig**：API配置组件，管理辅助AI的连接设置
- **ResponsePreview**：响应预览组件，可视化展示AI分析结果
- **ParallelAIPlugin**：实际集成到May聊天应用的运行时组件

各组件关系如下图所示：

```
+-------------------------------------------+
|                                           |
|  PluginDemo (配置与测试环境)              |
|                                           |
|  +------------+  +------------+  +------+ |
|  |            |  |            |  |      | |
|  | PromptEditor|  | ApiConfig  |  |Response|
|  |            |  |            |  |Preview| |
|  +------------+  +------------+  +------+ |
|                                           |
+-------------------------------------------+
              |
              | 配置保存到数据库
              ↓
+-------------------------------------------+
|                                           |
|  ParallelAIPlugin (运行时组件)           |
|                                           |
|  +------------+  +------------+          |
|  |            |  |            |          |
|  | 提示词处理  |  | UI交互逻辑 |          |
|  |            |  |            |          |
|  +------------+  +------------+          |
|                                           |
+-------------------------------------------+
```

### 2.2 数据流

平行AI插件的数据流如下：

1. **配置阶段**：
   - 用户通过PluginDemo配置系统提示词、响应映射和API设置
   - 配置信息保存到数据库（使用db.js模块）

2. **运行阶段**：
   - 用户在May中输入消息
   - 消息同时发送给主AI（处理常规对话）和辅助AI（进行意图分析）
   - 辅助AI根据预设提示词分析用户意图并返回结构化JSON
   - 系统解析JSON响应，如果识别出特定意图，展示对应交互界面
   - 用户可选择接受或忽略辅助功能建议

3. **数据存储**：
   - 系统提示词、响应映射和API配置保存在数据库中
   - API密钥通过加密方式存储，确保安全性

## 3. 关键设计

### 3.1 提示词工程设计原则

平行AI插件的核心是基于精心设计的提示词，遵循以下设计原则：

1. **明确目标任务**：清晰定义AI需要执行的任务（如"识别销售话术场景"）
2. **提供具体示例**：包含明确的输入/输出示例，帮助AI理解预期行为
3. **定义输出格式**：严格规定JSON响应的结构和字段命名
4. **边界条件处理**：明确指出何时返回特定结果（如type="none"）
5. **逻辑关系清晰**：使用编号列表和分隔符划分不同任务部分
6. **可替换占位符**：使用{userPrompt}等占位符便于运行时替换

### 3.2 结构化输出格式规范

插件定义了严格的JSON响应格式：

```json
{
  "type": "a" | "b" | "none",
  "suggestion": {
    "text": "提示文本",
    "input": {
      // 对于type="a"(销售话术)场景：
      "product": "提取的产品名称",
      "position": "提取的目标客户职位"
      // 对于type="b"(市场分析)场景：
      "product": "提取的产品名称"
    }
  }
}
```

这种格式设计有以下优势：
- **类型枚举化**：使用固定的类型标识符，避免模糊不清的描述
- **层次化结构**：使用嵌套对象组织相关信息
- **适应性字段**：根据不同的类型提供不同的字段结构
- **必要信息提取**：明确从用户输入中提取关键实体（产品、职位等）

### 3.3 UI交互模式

插件采用了非侵入式的交互设计，主要特点：

1. **独立卡片设计**：辅助功能建议以独立卡片形式展示，不干扰主对话
2. **双选项交互**：用户可以选择"忽略"或"执行"建议
3. **预填参数展示**：显示从用户输入中提取的关键参数
4. **一致的品牌风格**：使用系统主题色和UI组件，保持视觉一致性

## 4. 实现细节

### 4.1 提示词编辑器实现

提示词编辑器`PromptEditor`组件实现了以下功能：

- 标签页式界面，包含"提示词编辑"和"响应配置"两个标签页
- Monaco编辑器提供语法高亮和代码补全
- 实时保存编辑内容到状态
- 提供占位符提示和格式指导

关键代码示例：
```jsx
// 提示词编辑区
{activeTab === 'prompt' && (
  <div>
    <textarea
      value={systemPrompt}
      onChange={handlePromptChange}
      style={{ /* 样式 */ }}
    />
    <p>
      提示: 使用 {'{userPrompt}'} 作为用户输入的占位符
    </p>
  </div>
)}
```

### 4.2 响应预览功能

响应预览`ResponsePreview`组件实现了结果可视化：

- 多状态展示：初始状态、错误状态、结果预览
- 原始JSON响应和UI效果并列展示
- 根据响应类型动态渲染不同UI

响应解析关键代码：
```javascript
// 尝试清理并解析JSON响应
const cleanedContent = content
  .replace(/^```(json)?/, '') // 移除开始的```json或```
  .replace(/```$/, '')        // 移除结束的```
  .replace(/^\s+|\s+$/g, '')  // 移除前后空白
  .replace(/\|$/, '');        // 移除末尾可能的|符号
    
// 尝试解析JSON响应
const parsedResult = JSON.parse(cleanedContent);
```

### 4.3 平行AI集成方式

`ParallelAIPlugin`组件实现了以下集成逻辑：

- 监听用户输入变化并触发分析
- 从数据库加载配置信息
- 处理AI响应并展示适当的UI
- 管理忽略/执行操作

集成到主应用的方法：
```jsx
// 在ChatInterface.tsx中导入此组件:
import ParallelAIPlugin from '../Plugin/ParallelAIPlugin';

// 在InputArea组件附近添加此组件:
<ParallelAIPlugin 
  userInput={currentUserInput} 
  showSuggestion={true}
/>
```

### 4.4 数据存储和配置管理

插件使用了多种存储机制来保存配置：

- 主要使用`db.js`模块进行数据库存储
- 提供了`localStorage`作为兼容性备选方案
- API密钥通过`encryptData`和`decryptData`函数加密存储

数据库操作示例：
```javascript
// 保存系统提示词
await saveConfig('plugin-system-prompt', systemPrompt);

// 保存响应映射
await saveConfig('plugin-response-mapping', JSON.stringify(responseMapping));

// 加密并保存API密钥
if (apiConfig.apiKey) {
  const encryptedKey = encryptData(apiConfig.apiKey);
  await saveConfig('secondary-api-key', encryptedKey);
}
```

## 5. 使用指南

### 5.1 配置步骤

1. **访问配置页面**：
   - 通过URL参数访问：`/?demo=plugin`
   - 或通过快捷键：fn+A+P+I

2. **配置API设置**：
   - 输入辅助AI的API密钥
   - 设置API基础URL（默认为火山服务）
   - 选择模型（如火山Deepseek V3）
   - 启用平行AI分析功能

3. **编辑系统提示词**：
   - 使用提示词编辑器修改系统提示词
   - 确保包含`{userPrompt}`占位符
   - 定义清晰的输出格式和规则

4. **配置响应映射**：
   - 切换到"响应配置"标签页
   - 为销售话术(type="a")设置提示文本和按钮文本
   - 为市场分析(type="b")设置提示文本和按钮文本

5. **保存配置**：
   - 点击右上角"保存到May"按钮保存所有配置

### 5.2 测试和调试

1. **模拟用户输入**：
   - 在"用户输入模拟"文本框中输入测试内容
   - 或使用预设的测试案例按钮快速填充常见场景

2. **执行测试分析**：
   - 点击"测试分析"按钮，发送请求到辅助AI
   - 查看原始API响应和解析后的JSON结果

3. **预览UI效果**：
   - 在"UI效果预览"面板查看最终用户界面
   - 验证提取的参数是否正确显示

4. **解决常见问题**：
   - 检查JSON格式是否符合预期结构
   - 验证API密钥和URL配置是否正确
   - 确认提示词中的占位符格式正确

### 5.3 集成到应用中

1. **导入组件**：
   ```jsx
   import ParallelAIPlugin from '../Plugin/ParallelAIPlugin';
   ```

2. **添加到聊天界面**：
   ```jsx
   <ParallelAIPlugin 
     userInput={currentUserInput} 
     showSuggestion={true}
   />
   ```

3. **触发条件控制**：
   可以根据需要控制`showSuggestion`属性来决定何时展示建议

## 6. 最佳实践与未来展望

### 6.1 提示词设计最佳实践

1. **任务分解**：将复杂任务分解为可管理的子任务
2. **清晰指令**：使用明确、简洁的指令语言
3. **输出示例**：提供完整的输出格式示例
4. **逻辑流程**：使用编号列表说明处理流程
5. **验证规则**：明确何时返回何种结果的条件
6. **错误处理**：说明如何处理边界情况和缺失信息

### 6.2 MCP模式的扩展应用

MCP模式可以扩展到更多场景：

1. **多模态应用**：扩展到图像、音频等多模态输入分析
2. **复杂工作流**：构建多步骤、多分支的交互流程
3. **业务流程集成**：对接CRM、ERP等企业系统
4. **多领域专家**：部署多个专门领域的辅助AI分析器
5. **个性化定制**：根据用户历史行为定制分析模式

### 6.3 未来改进方向

平行AI插件可以在以下方向进一步优化：

1. **增加更多场景**：扩展当前的两种场景类型，增加更多专业分析
2. **自适应提示词**：根据用户反馈自动优化提示词
3. **模型性能监控**：跟踪和分析模型响应质量
4. **跨会话记忆**：保存用户偏好和常用场景
5. **提示词模板库**：建立可复用的提示词模板集合
6. **多模型异步分析**：同时使用多个不同的AI模型进行并行分析
7. **低代码集成**：提供更简便的方式将MCP集成到其他应用

## 7. 结论

MCP模式代表了AI应用开发的一个新范式，通过结构化提示词和标准化输出，实现了AI与传统软件系统的无缝集成。平行AI分析插件是这一模式的实际应用，它展示了如何利用辅助AI增强主要对话系统的功能，提升用户体验。

通过精心设计的提示词工程和灵活的UI交互，该插件实现了AI能力的可控扩展，为May聊天应用增添了智能化的场景识别和功能推荐能力。这一模式不仅适用于聊天系统，也可以扩展到各种需要AI与传统软件协同工作的场景。

未来，随着大语言模型能力的持续提升，MCP模式将发挥更大的价值，让AI真正成为现有系统的智能增强层，而不仅仅是独立的对话接口。
